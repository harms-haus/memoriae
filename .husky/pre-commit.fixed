#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Load nvm if available (for npm/node via nvm)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Ensure npm is in PATH - add nvm's default node version path as fallback
# This handles cases where nvm doesn't load properly in git hooks
if [ -d "$HOME/.nvm/versions/node" ]; then
  # Add the most recent node version (or use default if set)
  DEFAULT_NODE=$(ls -t "$HOME/.nvm/versions/node" 2>/dev/null | head -1)
  if [ -n "$DEFAULT_NODE" ] && [ -d "$HOME/.nvm/versions/node/$DEFAULT_NODE/bin" ]; then
    export PATH="$HOME/.nvm/versions/node/$DEFAULT_NODE/bin:$PATH"
  fi
fi

# Additional fallback paths
export PATH="$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ensure npm is non-interactive (prevent hanging)
export npm_config_progress=false
export npm_config_update_notifier=false
export CI=true
# Prevent npm from trying to update or check for updates
export npm_config_loglevel=error

# Run command with timeout protection
run_with_timeout() {
  local timeout_seconds="$1"
  local operation_name="$2"
  shift 2
  
  echo "${BLUE}Running '$operation_name'...${NC}"
  timeout "$timeout_seconds" "$@"
  local exit_code=$?
  
  if [ $exit_code -eq 124 ]; then
    echo "${RED}âŒ ERROR: '$operation_name' timed out after ${timeout_seconds} seconds${NC}"
    return 124
  elif [ $exit_code -ne 0 ]; then
    echo "${RED}âŒ ERROR: '$operation_name' failed with exit code $exit_code${NC}"
    return $exit_code
  else
    echo "${GREEN}âœ… SUCCESS: '$operation_name' completed${NC}"
    return 0
  fi
}

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Check if any files are staged
if [ -z "$STAGED_FILES" ]; then
  echo "${YELLOW}No staged files, skipping tests${NC}"
  exit 0
fi

# Determine which modules have changed
MOTHER_CHANGED=false
FRONTEND_CHANGED=false
BACKEND_CHANGED=false

# Track which modules have TypeScript changes (need type-check)
MOTHER_NEEDS_TYPECHECK=false
FRONTEND_NEEDS_TYPECHECK=false
BACKEND_NEEDS_TYPECHECK=false

# Check for changes in each module
for file in $STAGED_FILES; do
  case "$file" in
    mother-theme/*)
      MOTHER_CHANGED=true
      # Check if it's a TypeScript file or config that affects types
      case "$file" in
        *.ts|*.tsx|*.d.ts|tsconfig.json|package.json)
          MOTHER_NEEDS_TYPECHECK=true
          ;;
      esac
      ;;
    frontend/*)
      FRONTEND_CHANGED=true
      case "$file" in
        *.ts|*.tsx|*.d.ts|tsconfig.json|package.json|vite.config.ts)
          FRONTEND_NEEDS_TYPECHECK=true
          ;;
      esac
      ;;
    backend/*)
      BACKEND_CHANGED=true
      case "$file" in
        *.ts|*.tsx|*.d.ts|tsconfig.json|package.json)
          BACKEND_NEEDS_TYPECHECK=true
          ;;
      esac
      ;;
    # Root-level changes might affect multiple modules
    package.json|*.md|.gitignore|.husky/*)
      # Don't trigger tests for root config/docs
      ;;
    *)
      # Unknown file location - be safe and run all tests
      # Or you could be more specific about what triggers full test runs
      ;;
  esac
done

# Track if any tests failed
TESTS_FAILED=0

# Helper function to check if only non-code files changed
check_non_code_only() {
  local files="$1"
  # If no files, return false (not non-code only)
  if [ -z "$files" ]; then
    return 1
  fi
  for file in $files; do
    case "$file" in
      *.md|*.txt|*.json|*.yml|*.yaml|.gitignore|.editorconfig|*.lock|*.log|*.png|*.jpg|*.jpeg|*.svg|*.gif)
        # Non-code file, continue checking
        ;;
      *)
        # Found a code file, return false (need to run tests)
        return 1
        ;;
    esac
  done
  # Only non-code files found, return true (skip tests)
  return 0
}

# Helper to get elapsed time
get_elapsed() {
  local start=$1
  local end=$(date +%s)
  echo $((end - start))
}

# Run tests for mother-theme if changed
if [ "$MOTHER_CHANGED" = true ]; then
  # Check if only non-code files changed
  MOTHER_FILES=$(echo "$STAGED_FILES" | grep "^mother-theme/")
  if check_non_code_only "$MOTHER_FILES"; then
    echo "${YELLOW}â­ï¸  Skipping mother-theme tests (only non-code files changed)${NC}"
  else
    echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ğŸ§ª Testing mother-theme${NC}"
    echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    if [ -d "mother-theme" ]; then
      cd mother-theme || exit 1
      START_TIME=$(date +%s)
      
      # Check if dependencies are installed
      if [ ! -d "node_modules" ]; then
        echo "${YELLOW}âš ï¸  node_modules not found in mother-theme${NC}"
        echo "${YELLOW}   Installing dependencies...${NC}"
        # TIMEOUT: 5 minutes for npm install
        if ! run_with_timeout 300 "npm install for mother-theme" npm install --silent --no-audit --no-fund; then
          echo "${RED}âŒ Failed to install dependencies${NC}"
          cd .. || exit 1
          TESTS_FAILED=1
        fi
      fi
      
      # Only proceed if dependencies are available
      if [ $TESTS_FAILED -eq 0 ] && [ -d "node_modules" ]; then
        # Only run type-check if TypeScript files changed
        if [ "$MOTHER_NEEDS_TYPECHECK" = true ]; then
          echo "Running type-check (TypeScript files changed)..."
          # TIMEOUT: 2 minutes for type-check
          if ! run_with_timeout 120 "type-check for mother-theme" npm run type-check 2>&1; then
            TESTS_FAILED=1
          fi
        else
          echo "${YELLOW}â­ï¸  Skipping type-check (no TypeScript files changed)${NC}"
        fi
        
        if [ $TESTS_FAILED -eq 0 ]; then
          echo "Running unit tests..."
          # TIMEOUT: 3 minutes for tests
          if ! run_with_timeout 180 "tests for mother-theme" npm test 2>&1; then
            TESTS_FAILED=1
          fi
        fi
      fi
      
      TOTAL_TIME=$(get_elapsed $START_TIME)
      cd .. || exit 1
      
      if [ $TESTS_FAILED -eq 1 ]; then
        echo "${RED}âŒ mother-theme tests failed (${TOTAL_TIME}s total)${NC}"
      else
        echo "${GREEN}âœ… mother-theme tests passed (${TOTAL_TIME}s total)${NC}"
      fi
    else
      echo "${YELLOW}âš ï¸  mother-theme directory not found, skipping${NC}"
    fi
  fi
fi

# Run tests for backend if changed
if [ "$BACKEND_CHANGED" = true ]; then
  # Check if only non-code files changed
  BACKEND_FILES=$(echo "$STAGED_FILES" | grep "^backend/")
  if check_non_code_only "$BACKEND_FILES"; then
    echo "${YELLOW}â­ï¸  Skipping backend tests (only non-code files changed)${NC}"
  else
    echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ğŸ§ª Testing backend${NC}"
    echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    if [ -d "backend" ]; then
      cd backend || exit 1
      START_TIME=$(date +%s)
      
      # Check if dependencies are installed
      if [ ! -d "node_modules" ]; then
        echo "${YELLOW}âš ï¸  node_modules not found in backend${NC}"
        echo "${YELLOW}   Installing dependencies...${NC}"
        # TIMEOUT: 5 minutes for npm install
        if ! run_with_timeout 300 "npm install for backend" npm install --silent --no-audit --no-fund; then
          echo "${RED}âŒ Failed to install dependencies${NC}"
          cd .. || exit 1
          TESTS_FAILED=1
        fi
      fi
      
      # Only proceed if dependencies are available
      if [ $TESTS_FAILED -eq 0 ] && [ -d "node_modules" ]; then
        # Only run type-check if TypeScript files changed
        if [ "$BACKEND_NEEDS_TYPECHECK" = true ]; then
          echo "Running type-check (TypeScript files changed)..."
          # TIMEOUT: 2 minutes for type-check
          if ! run_with_timeout 120 "type-check for backend" npm run type-check 2>&1; then
            TESTS_FAILED=1
          fi
        else
          echo "${YELLOW}â­ï¸  Skipping type-check (no TypeScript files changed)${NC}"
        fi
        
        if [ $TESTS_FAILED -eq 0 ]; then
          echo "Running unit tests..."
          # TIMEOUT: 3 minutes for tests
          if ! run_with_timeout 180 "tests for backend" npm run test:unit 2>&1; then
            TESTS_FAILED=1
          fi
        fi
      fi
      
      TOTAL_TIME=$(get_elapsed $START_TIME)
      cd .. || exit 1
      
      if [ $TESTS_FAILED -eq 1 ]; then
        echo "${RED}âŒ backend tests failed (${TOTAL_TIME}s total)${NC}"
      else
        echo "${GREEN}âœ… backend tests passed (${TOTAL_TIME}s total)${NC}"
      fi
    else
      echo "${YELLOW}âš ï¸  backend directory not found, skipping${NC}"
    fi
  fi
fi

# Run tests for frontend if changed
if [ "$FRONTEND_CHANGED" = true ]; then
  # Check if only non-code files changed
  FRONTEND_FILES=$(echo "$STAGED_FILES" | grep "^frontend/")
  if check_non_code_only "$FRONTEND_FILES"; then
    echo "${YELLOW}â­ï¸  Skipping frontend tests (only non-code files changed)${NC}"
  else
    echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo "${BLUE}ğŸ§ª Testing frontend${NC}"
    echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    
    if [ -d "frontend" ]; then
      cd frontend || exit 1
      START_TIME=$(date +%s)
      
      # Check if dependencies are installed
      if [ ! -d "node_modules" ]; then
        echo "${YELLOW}âš ï¸  node_modules not found in frontend${NC}"
        echo "${YELLOW}   Installing dependencies...${NC}"
        # TIMEOUT: 5 minutes for npm install
        if ! run_with_timeout 300 "npm install for frontend" npm install --silent --no-audit --no-fund; then
          echo "${RED}âŒ Failed to install dependencies${NC}"
          cd .. || exit 1
          TESTS_FAILED=1
        fi
      fi
      
      # Only proceed if dependencies are available
      if [ $TESTS_FAILED -eq 0 ] && [ -d "node_modules" ]; then
        # Only run type-check if TypeScript files changed
        if [ "$FRONTEND_NEEDS_TYPECHECK" = true ]; then
          echo "Running type-check (TypeScript files changed)..."
          # TIMEOUT: 2 minutes for type-check
          if ! run_with_timeout 120 "type-check for frontend" npm run type-check 2>&1; then
            TESTS_FAILED=1
          fi
        else
          echo "${YELLOW}â­ï¸  Skipping type-check (no TypeScript files changed)${NC}"
        fi
        
        if [ $TESTS_FAILED -eq 0 ]; then
          echo "Running unit tests..."
          # TIMEOUT: 3 minutes for tests
          if ! run_with_timeout 180 "tests for frontend" npm run test:unit 2>&1; then
            TESTS_FAILED=1
          fi
        fi
      fi
      
      TOTAL_TIME=$(get_elapsed $START_TIME)
      cd .. || exit 1
      
      if [ $TESTS_FAILED -eq 1 ]; then
        echo "${RED}âŒ frontend tests failed (${TOTAL_TIME}s total)${NC}"
      else
        echo "${GREEN}âœ… frontend tests passed (${TOTAL_TIME}s total)${NC}"
      fi
    else
      echo "${YELLOW}âš ï¸  frontend directory not found, skipping${NC}"
    fi
  fi
fi

# If no modules were detected as changed, show a message
if [ "$MOTHER_CHANGED" = false ] && [ "$FRONTEND_CHANGED" = false ] && [ "$BACKEND_CHANGED" = false ]; then
  echo "${YELLOW}âš ï¸  No testable files changed (staged files don't match known modules)${NC}"
  echo "${YELLOW}   Staged files:${NC}"
  echo "$STAGED_FILES" | sed 's/^/   - /'
  echo ""
  echo "${YELLOW}   Skipping tests. If you want to run tests anyway, use:${NC}"
  echo "${YELLOW}   git commit --no-verify${NC}"
fi

# Exit with error if any tests failed
if [ $TESTS_FAILED -eq 1 ]; then
  echo ""
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${RED}âŒ Pre-commit hook failed: Tests failed${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  exit 1
fi

# Success message
if [ "$MOTHER_CHANGED" = true ] || [ "$FRONTEND_CHANGED" = true ] || [ "$BACKEND_CHANGED" = true ]; then
  echo ""
  echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${GREEN}âœ… All tests passed!${NC}"
  echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
fi

exit 0