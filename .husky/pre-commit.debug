#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# DIAGNOSTIC VERSION - Enhanced logging and timeouts to identify timeout sources
# This version adds timeout limits and detailed timing for each operation

# Load nvm if available (for npm/node via nvm)
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

# Ensure npm is in PATH - add nvm's default node version path as fallback
if [ -d "$HOME/.nvm/versions/node" ]; then
  DEFAULT_NODE=$(ls -t "$HOME/.nvm/versions/node" 2>/dev/null | head -1)
  if [ -n "$DEFAULT_NODE" ] && [ -d "$HOME/.nvm/versions/node/$DEFAULT_NODE/bin" ]; then
    export PATH="$HOME/.nvm/versions/node/$DEFAULT_NODE/bin:$PATH"
  fi
fi

# Additional fallback paths
export PATH="$HOME/.local/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Ensure npm is non-interactive
export npm_config_progress=false
export npm_config_update_notifier=false
export CI=true
export npm_config_loglevel=error

# DIAGNOSTIC: Add timeout wrapper function
run_with_timeout() {
  local timeout_seconds="$1"
  local operation_name="$2"
  shift 2
  
  echo "${PURPLE}ğŸ” DIAGNOSTIC: Starting '$operation_name' with ${timeout_seconds}s timeout${NC}"
  local start_time=$(date +%s)
  
  # Run command with timeout using timeout utility
  local output
  local exit_code
  output=$(timeout "$timeout_seconds" "$@" 2>&1)
  exit_code=$?
  
  local end_time=$(date +%s)
  local duration=$((end_time - start_time))
  
  if [ $exit_code -eq 124 ]; then
    echo "${RED}âŒ TIMEOUT: '$operation_name' exceeded ${timeout_seconds}s (took ${duration}s)${NC}"
    echo "${RED}   This operation timed out and may be the source of your pre-commit timeout${NC}"
    return 124
  elif [ $exit_code -ne 0 ]; then
    echo "${RED}âŒ ERROR: '$operation_name' failed with exit code $exit_code (took ${duration}s)${NC}"
    echo "${RED}   Output: $output${NC}"
    return $exit_code
  else
    echo "${GREEN}âœ… SUCCESS: '$operation_name' completed in ${duration}s${NC}"
    return 0
  fi
}

# DIAGNOSTIC: Enhanced elapsed time function
get_elapsed() {
  local start=$1
  local end=$(date +%s)
  echo $((end - start))
}

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BLUE}ğŸ” DIAGNOSTIC PRE-COMMIT HOOK (v2.0)${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# DIAGNOSTIC: Track overall execution time
OVERALL_START=$(date +%s)

# Get list of staged files
echo "${PURPLE}ğŸ“‹ DIAGNOSTIC: Getting staged files...${NC}"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
echo "${PURPLE}   Staged files: $(echo "$STAGED_FILES" | wc -w)${NC}"

if [ -z "$STAGED_FILES" ]; then
  echo "${YELLOW}â­ï¸  No staged files, skipping tests${NC}"
  exit 0
fi

# Determine which modules have changed
MOTHER_CHANGED=false
FRONTEND_CHANGED=false
BACKEND_CHANGED=false

MOTHER_NEEDS_TYPECHECK=false
FRONTEND_NEEDS_TYPECHECK=false
BACKEND_NEEDS_TYPECHECK=false

echo "${PURPLE}ğŸ” DIAGNOSTIC: Analyzing staged files...${NC}"

# Check for changes in each module
for file in $STAGED_FILES; do
  case "$file" in
    mother-theme/*)
      MOTHER_CHANGED=true
      case "$file" in
        *.ts|*.tsx|*.d.ts|tsconfig.json|package.json)
          MOTHER_NEEDS_TYPECHECK=true
          ;;
      esac
      ;;
    frontend/*)
      FRONTEND_CHANGED=true
      case "$file" in
        *.ts|*.tsx|*.d.ts|tsconfig.json|package.json|vite.config.ts)
          FRONTEND_NEEDS_TYPECHECK=true
          ;;
      esac
      ;;
    backend/*)
      BACKEND_CHANGED=true
      case "$file" in
        *.ts|*.tsx|*.d.ts|tsconfig.json|package.json)
          BACKEND_NEEDS_TYPECHECK=true
          ;;
      esac
      ;;
  esac
done

echo "${PURPLE}   Modules changed: mother-theme=$MOTHER_CHANGED, frontend=$FRONTEND_CHANGED, backend=$BACKEND_CHANGED${NC}"
echo "${PURPLE}   TypeScript checks needed: mother-theme=$MOTHER_NEEDS_TYPECHECK, frontend=$FRONTEND_NEEDS_TYPECHECK, backend=$BACKEND_NEEDS_TYPECHECK${NC}"

# Track if any tests failed
TESTS_FAILED=0

# Helper function to check if only non-code files changed
check_non_code_only() {
  local files="$1"
  if [ -z "$files" ]; then
    return 1
  fi
  for file in $files; do
    case "$file" in
      *.md|*.txt|*.json|*.yml|*.yaml|.gitignore|.editorconfig|*.lock|*.log|*.png|*.jpg|*.jpeg|*.svg|*.gif)
        ;;
      *)
        return 1
        ;;
    esac
  done
  return 0
}

# DIAGNOSTIC: Enhanced module testing with timeouts and detailed logging
test_module() {
  local module_name="$1"
  local module_path="$2"
  local changed="$3"
  local needs_typecheck="$4"
  local staged_files="$5"
  
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${BLUE}ğŸ§ª Testing $module_name (DIAGNOSTIC MODE)${NC}"
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  
  if [ "$changed" != "true" ]; then
    echo "${YELLOW}â­ï¸  Skipping $module_name (no changes detected)${NC}"
    return 0
  fi
  
  # Check if only non-code files changed
  MODULE_FILES=$(echo "$staged_files" | grep "^$module_path/")
  if check_non_code_only "$MODULE_FILES"; then
    echo "${YELLOW}â­ï¸  Skipping $module_name tests (only non-code files changed)${NC}"
    return 0
  fi
  
  if [ ! -d "$module_path" ]; then
    echo "${YELLOW}âš ï¸  $module_path directory not found, skipping${NC}"
    return 0
  fi
  
  cd "$module_path" || exit 1
  MODULE_START=$(date +%s)
  
  # DIAGNOSTIC: Check dependencies with timeout
  echo "${PURPLE}ğŸ” DIAGNOSTIC: Checking dependencies for $module_name...${NC}"
  if [ ! -d "node_modules" ]; then
    echo "${YELLOW}âš ï¸  node_modules not found in $module_name${NC}"
    echo "${YELLOW}   Installing dependencies...${NC}"
    
    # DIAGNOSTIC: Use run_with_timeout for npm install (300s = 5 minutes max)
    if ! run_with_timeout 300 "npm install for $module_name" npm install --silent --no-audit --no-fund; then
      echo "${RED}âŒ Failed to install dependencies for $module_name${NC}"
      cd .. || exit 1
      TESTS_FAILED=1
      return 1
    fi
  else
    echo "${GREEN}âœ… Dependencies already installed for $module_name${NC}"
  fi
  
  # DIAGNOSTIC: Check if dependencies are actually usable
  if [ $TESTS_FAILED -eq 0 ] && [ -d "node_modules" ]; then
    echo "${PURPLE}ğŸ” DIAGNOSTIC: Verifying npm accessibility...${NC}"
    if ! run_with_timeout 10 "npm --version check" npm --version >/dev/null 2>&1; then
      echo "${RED}âŒ npm not accessible in $module_name${NC}"
      cd .. || exit 1
      TESTS_FAILED=1
      return 1
    fi
    
    # DIAGNOSTIC: Check package.json scripts
    if [ -f "package.json" ]; then
      echo "${PURPLE}ğŸ” DIAGNOSTIC: Available scripts in $module_name/package.json:${NC}"
      npm run --silent 2>/dev/null | grep -E "^  [a-zA-Z-]+:" | head -5 | sed 's/^/   - /'
    fi
  fi
  
  # DIAGNOSTIC: Type check with timeout (only if TypeScript files changed)
  if [ $TESTS_FAILED -eq 0 ] && [ "$needs_typecheck" = "true" ]; then
    echo "${PURPLE}ğŸ” DIAGNOSTIC: Running type-check for $module_name...${NC}"
    
    # Check if type-check script exists
    if npm run --silent 2>/dev/null | grep -q "type-check:"; then
      if ! run_with_timeout 120 "type-check for $module_name" npm run type-check; then
        echo "${RED}âŒ Type-check failed for $module_name${NC}"
        TESTS_FAILED=1
      fi
    else
      echo "${YELLOW}â­ï¸  No type-check script found in $module_name${NC}"
    fi
  else
    echo "${YELLOW}â­ï¸  Skipping type-check for $module_name (no TypeScript files changed)${NC}"
  fi
  
  # DIAGNOSTIC: Tests with timeout
  if [ $TESTS_FAILED -eq 0 ]; then
    echo "${PURPLE}ğŸ” DIAGNOSTIC: Running tests for $module_name...${NC}"
    
    # Determine test command based on module
    local test_cmd="npm test"
    case "$module_name" in
      "backend"|"mother-theme")
        test_cmd="npm run test:unit"
        ;;
      "frontend")
        test_cmd="npm run test:unit"
        ;;
    esac
    
    # Check if test script exists
    if npm run --silent 2>/dev/null | grep -q "test"; then
      # DIAGNOSTIC: Use run_with_timeout for tests (180s = 3 minutes max)
      if ! run_with_timeout 180 "tests for $module_name" npm run test:unit; then
        echo "${RED}âŒ Tests failed for $module_name${NC}"
        TESTS_FAILED=1
      fi
    else
      echo "${YELLOW}â­ï¸  No test script found in $module_name${NC}"
    fi
  fi
  
  MODULE_END=$(date +%s)
  MODULE_DURATION=$((MODULE_END - MODULE_START))
  cd .. || exit 1
  
  if [ $TESTS_FAILED -eq 1 ]; then
    echo "${RED}âŒ $module_name tests failed (${MODULE_DURATION}s total)${NC}"
  else
    echo "${GREEN}âœ… $module_name tests passed (${MODULE_DURATION}s total)${NC}"
  fi
}

# Test each module that has changes
test_module "mother-theme" "mother-theme" "$MOTHER_CHANGED" "$MOTHER_NEEDS_TYPECHECK" "$STAGED_FILES"
test_module "backend" "backend" "$BACKEND_CHANGED" "$BACKEND_NEEDS_TYPECHECK" "$STAGED_FILES"
test_module "frontend" "frontend" "$FRONTEND_CHANGED" "$FRONTEND_NEEDS_TYPECHECK" "$STAGED_FILES"

# DIAGNOSTIC: Summary
OVERALL_END=$(date +%s)
OVERALL_DURATION=$((OVERALL_END - OVERALL_START))

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BLUE}ğŸ“Š DIAGNOSTIC SUMMARY${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${PURPLE}Total execution time: ${OVERALL_DURATION}s${NC}"

if [ "$MOTHER_CHANGED" = "true" ]; then
  echo "  â€¢ mother-theme: Tested"
else
  echo "  â€¢ mother-theme: Skipped (no changes)"
fi

if [ "$BACKEND_CHANGED" = "true" ]; then
  echo "  â€¢ backend: Tested"
else
  echo "  â€¢ backend: Skipped (no changes)"
fi

if [ "$FRONTEND_CHANGED" = "true" ]; then
  echo "  â€¢ frontend: Tested"
else
  echo "  â€¢ frontend: Skipped (no changes)"
fi

if [ $TESTS_FAILED -eq 1 ]; then
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${RED}âŒ Pre-commit hook failed: Tests failed${NC}"
  echo "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${YELLOW}ğŸ’¡ DIAGNOSTIC TIP: If this timed out, check which operation exceeded its timeout limit above${NC}"
  exit 1
fi

# Success message
if [ "$MOTHER_CHANGED" = "true" ] || [ "$FRONTEND_CHANGED" = "true" ] || [ "$BACKEND_CHANGED" = "true" ]; then
  echo ""
  echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo "${GREEN}âœ… All tests passed!${NC}"
  echo "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
fi

echo "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${YELLOW}ğŸ’¡ If you want to disable this diagnostic mode, replace .husky/pre-commit with .husky/pre-commit.backup${NC}"
echo "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

exit 0