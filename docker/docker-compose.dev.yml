version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: memoriae-postgres-dev
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-memoriae}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-memoriae}
      POSTGRES_DB: ${POSTGRES_DB:-memoriae}
      # Set default authentication method for network connections
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      # Persistent volume - data survives container recreation
      # CRITICAL: This volume contains all your database data
      - memoriae-postgres-data-dev:/var/lib/postgresql/data
      # Init script runs once on first database initialization only
      - ./init-postgres-hba.sh:/docker-entrypoint-initdb.d/01-init-hba.sh:ro
    # Configure PostgreSQL to listen on all network interfaces
    command: ["postgres", "-c", "listen_addresses=*"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-memoriae}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - memoriae-network-dev

  redis:
    image: redis:7-alpine
    container_name: memoriae-redis-dev
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - memoriae-redis-data-dev:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - memoriae-network-dev

  memoriae:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: memoriae-dev
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "${PORT:-3123}:3123"
      - "5173:5173"   # Frontend Vite dev server
      - "9229:9229"   # Node.js debugging
    volumes:
      # Mount source code for hot reload
      - ../backend:/app/backend:rw
      - ../frontend:/app/frontend:rw
      - ../mother-theme:/app/mother-theme:rw
      # Exclude node_modules from volume mount (use container's node_modules)
      - /app/backend/node_modules
      - /app/frontend/node_modules
      - /app/mother-theme/node_modules
    env_file:
      - ../.env
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://${POSTGRES_USER:-memoriae}:${POSTGRES_PASSWORD:-memoriae}@postgres:5432/${POSTGRES_DB:-memoriae}
      - REDIS_URL=redis://redis:6379
      - PORT=${PORT:-3123}
      - JWT_SECRET=${JWT_SECRET:-dev-secret-change-in-production}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - OPENROUTER_API_URL=${OPENROUTER_API_URL:-https://openrouter.ai/api/v1}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
    # DNS configuration: By default, Podman/Docker inherits DNS from the host.
    # If DNS resolution fails (e.g., "getaddrinfo EAI_AGAIN" errors), uncomment
    # the dns section below to use public DNS servers as a fallback.
    # This is typically needed when:
    # - Custom networks don't inherit host DNS properly
    # - systemd-resolved isn't accessible from containers
    # - Network isolation prevents host DNS access
    # dns:
    #   - 8.8.8.8     # Google DNS
    #   - 8.8.4.4     # Google DNS
    #   - 1.1.1.1     # Cloudflare DNS
    command: ["/bin/bash", "/start-dev.sh"]
    stdin_open: true
    tty: true
    restart: unless-stopped
    networks:
      - memoriae-network-dev

volumes:
  # Persistent volumes - data is preserved across container restarts
  # WARNING: These volumes contain your database data. Only remove with --clean if you want to lose all data.
  memoriae-postgres-data-dev:
    driver: local
    # Volume persists even if containers are removed
  memoriae-redis-data-dev:
    driver: local
    # Volume persists even if containers are removed

networks:
  memoriae-network-dev:
    driver: bridge
    # DNS is automatically inherited from the host by default
    # Podman/Docker will use the host's DNS resolver (systemd-resolved, etc.)
    # No explicit DNS configuration needed - containers inherit host DNS settings
