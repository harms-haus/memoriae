# syntax=docker/dockerfile:1
# Development Dockerfile for Memoriae
# This image only contains Node.js and the source code
# PostgreSQL and Redis are run as separate services in docker-compose

FROM node:22-slim

# Install curl for health checks and git for npm installs
RUN apt-get update && apt-get install -y \
    curl \
    git \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /app

# Copy root package files (for workspace setup)
COPY package*.json ./
COPY mother-theme/package*.json ./mother-theme/
COPY backend/package*.json ./backend/
COPY frontend/package*.json ./frontend/

# Install all dependencies (including dev dependencies)
RUN npm ci

# Copy source code (will be mounted as volume in docker-compose, but needed for initial setup)
COPY backend/ ./backend/
COPY frontend/ ./frontend/
COPY mother-theme/ ./mother-theme/

# Copy startup scripts
COPY docker/start-backend.sh /start-backend.sh
COPY docker/start-dev.sh /start-dev.sh
COPY docker/run-migrations.sh /run-migrations.sh
RUN chmod +x /start-backend.sh /start-dev.sh /run-migrations.sh

# Install PostgreSQL client for migration checks
RUN apt-get update && apt-get install -y \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Set working directory to backend for runtime
WORKDIR /app/backend

# Expose ports
# 3123 - Backend API
# 5173 - Frontend Vite dev server (if running frontend in same container)
# 9229 - Node.js debugging
EXPOSE 3123 5173 9229

# Set development environment
ENV NODE_ENV=development

# Default command: run backend dev server
# Frontend can be run separately or in the same container if needed
CMD ["npm", "run", "dev"]
